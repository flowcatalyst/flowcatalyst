# Quarkus Configuration

# =============================================================================
# Application Key (for local secret encryption)
# =============================================================================
# Used to encrypt secrets stored locally (encrypt: prefix)
# Generate with: openssl rand -base64 32
# IMPORTANT: Set FLOWCATALYST_APP_KEY in production!
flowcatalyst.app-key=${FLOWCATALYST_APP_KEY:}
%dev.flowcatalyst.app-key=K7gNU3sdo+OL0wNhqoVWhr3g6s1xYv72ol/pe/Unols=

# =============================================================================
# Auth Mode Configuration
# =============================================================================
# Mode: "embedded" (full IdP) or "remote" (token validation only)
flowcatalyst.auth.mode=${FLOWCATALYST_AUTH_MODE:embedded}

# External base URL (for OAuth/OIDC callbacks)
# Set this to the public URL of your platform (e.g., https://platform.example.com)
flowcatalyst.auth.external-base-url=${FLOWCATALYST_EXTERNAL_BASE_URL:}
%dev.flowcatalyst.auth.external-base-url=http://localhost:4200

# Remote mode settings (when mode=remote)
flowcatalyst.auth.remote.issuer=${FLOWCATALYST_AUTH_REMOTE_ISSUER:}
flowcatalyst.auth.remote.jwks-url=${FLOWCATALYST_AUTH_REMOTE_JWKS_URL:}
flowcatalyst.auth.remote.login-url=${FLOWCATALYST_AUTH_REMOTE_LOGIN_URL:}
flowcatalyst.auth.remote.logout-url=${FLOWCATALYST_AUTH_REMOTE_LOGOUT_URL:}
flowcatalyst.auth.remote.platform-url=${FLOWCATALYST_AUTH_REMOTE_PLATFORM_URL:}
flowcatalyst.auth.remote.jwks-cache-duration=${FLOWCATALYST_AUTH_REMOTE_JWKS_CACHE:PT1H}

# =============================================================================
# Bean Configuration
# =============================================================================

# Enable bean archive index at runtime for permission/role scanning
quarkus.arc.remove-unused-beans=false
quarkus.index-dependency.jandex.group-id=org.jboss
quarkus.index-dependency.jandex.artifact-id=jandex

# Always index all classes for annotation scanning
quarkus.index-dependency.backend.group-id=tech.flowcatalyst
quarkus.index-dependency.backend.artifact-id=flowcatalyst-backend
quarkus.index-dependency.platform.group-id=tech.flowcatalyst
quarkus.index-dependency.platform.artifact-id=flowcatalyst-platform

# Register config mappings from library modules
smallrye.config.mapping.validate-unknown=false


# =============================================================================
# JWT / Internal Authentication Configuration
# =============================================================================

# JWT issuer (appears in 'iss' claim)
flowcatalyst.auth.jwt.issuer=${FLOWCATALYST_JWT_ISSUER:flowcatalyst}

# JWT key paths (optional - if not set, keys are auto-generated on startup)
# For production, generate keys and configure these paths:
#   openssl genrsa -out jwt-private.pem 2048
#   openssl rsa -in jwt-private.pem -pubout -out jwt-public.pem
flowcatalyst.auth.jwt.private-key-path=${FLOWCATALYST_JWT_PRIVATE_KEY_PATH:}
flowcatalyst.auth.jwt.public-key-path=${FLOWCATALYST_JWT_PUBLIC_KEY_PATH:}

# Token expiry durations (ISO-8601 duration format)
flowcatalyst.auth.jwt.access-token-expiry=${FLOWCATALYST_ACCESS_TOKEN_EXPIRY:PT1H}
flowcatalyst.auth.jwt.session-token-expiry=${FLOWCATALYST_SESSION_TOKEN_EXPIRY:PT8H}
flowcatalyst.auth.jwt.refresh-token-expiry=${FLOWCATALYST_REFRESH_TOKEN_EXPIRY:P30D}
flowcatalyst.auth.jwt.authorization-code-expiry=${FLOWCATALYST_AUTH_CODE_EXPIRY:PT10M}

# Session cookie settings
flowcatalyst.auth.session.secure=${FLOWCATALYST_SESSION_SECURE:true}
flowcatalyst.auth.session.same-site=${FLOWCATALYST_SESSION_SAME_SITE:Lax}
flowcatalyst.auth.session.cookie-name=${FLOWCATALYST_SESSION_COOKIE:fc_session}

# PKCE settings (for OAuth2 authorization code flow)
flowcatalyst.auth.pkce.required=${FLOWCATALYST_PKCE_REQUIRED:true}

# Dev profile - less secure cookies for localhost
%dev.flowcatalyst.auth.session.secure=false

# =============================================================================
# SmallRye JWT Configuration (for token verification)
# =============================================================================

# Accept tokens from our own issuer
mp.jwt.verify.issuer=${flowcatalyst.auth.jwt.issuer}

# JWKS URL for token verification (points to our own endpoint)
# In production, set the full URL including hostname
mp.jwt.verify.publickey.location=${FLOWCATALYST_JWKS_URL:http://localhost:8080/.well-known/jwks.json}

# Token can come from cookie or Authorization header
mp.jwt.token.cookie=fc_session
mp.jwt.token.header=Authorization

# =============================================================================
# HTTP Auth Permissions (public endpoints)
# =============================================================================

# Auth endpoints must be public (login, token, discovery, OIDC federation)
quarkus.http.auth.permission.auth-public.paths=/auth/login,/auth/check-domain,/auth/oidc/*,/oauth/token,/.well-known/*
quarkus.http.auth.permission.auth-public.policy=permit

# Platform config endpoint public (needed before auth for UI initialization)
quarkus.http.auth.permission.config-public.paths=/api/config/platform
quarkus.http.auth.permission.config-public.policy=permit

# Health endpoints public
quarkus.http.auth.permission.health-public.paths=/q/health/*,/health/*
quarkus.http.auth.permission.health-public.policy=permit

# =============================================================================
# PostgreSQL Configuration (Primary Database)
# =============================================================================

# Production PostgreSQL settings (override via environment variables)
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=${POSTGRES_URL:jdbc:postgresql://localhost:5432/flowcatalyst}
quarkus.datasource.username=${POSTGRES_USER:flowcatalyst}
quarkus.datasource.password=${POSTGRES_PASSWORD:flowcatalyst}
quarkus.datasource.jdbc.max-size=20

# Dev profile
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/flowcatalyst
%dev.quarkus.datasource.username=flowcatalyst
%dev.quarkus.datasource.password=flowcatalyst

# =============================================================================
# Flyway Schema Migration
# =============================================================================
quarkus.flyway.migrate-at-start=true
quarkus.flyway.locations=classpath:db/migration
quarkus.flyway.baseline-on-migrate=true
quarkus.flyway.baseline-version=2

# Disable all Quarkus Dev Services (use docker-compose instead)
%dev.quarkus.devservices.enabled=false

# =============================================================================
# MongoDB Configuration (Kept temporarily for data migration)
# =============================================================================

# Production MongoDB settings (override via environment variables)
quarkus.mongodb.connection-string=${MONGODB_URL:mongodb://localhost:27017}
quarkus.mongodb.database=${MONGODB_DATABASE:flowcatalyst}

# Dev profile - single-node replica set (for change streams support)
# directConnection=true bypasses replica set discovery
%dev.quarkus.mongodb.connection-string=mongodb://localhost:27017/?replicaSet=rs0&directConnection=true
%dev.quarkus.mongodb.database=flowcatalyst

# =============================================================================
# IDP Configuration (Identity Provider)
# =============================================================================

# Anchor IDP (for anchor domain users)
flowcatalyst.idp.anchor.enabled=${IDP_ANCHOR_ENABLED:false}
flowcatalyst.idp.anchor.type=${IDP_ANCHOR_TYPE:KEYCLOAK}

# Platform IDP (for platform-managed users)
flowcatalyst.idp.platform.enabled=${IDP_PLATFORM_ENABLED:false}
flowcatalyst.idp.platform.type=${IDP_PLATFORM_TYPE:KEYCLOAK}

# =============================================================================
# Secret Management Configuration
# =============================================================================

# Default provider: encrypted, aws-sm, aws-ps, gcp-sm, vault
flowcatalyst.secrets.default-provider=${FLOWCATALYST_SECRETS_PROVIDER:encrypted}

# Encrypted provider (default) - AES-256-GCM encryption
# Option 1: Provide a base64-encoded 256-bit key
flowcatalyst.secrets.encryption.key=${FLOWCATALYST_SECRETS_ENCRYPTION_KEY:}
# Option 2: Derive key from passphrase (simpler but slightly less secure)
flowcatalyst.secrets.encryption.passphrase=${FLOWCATALYST_SECRETS_PASSPHRASE:}
flowcatalyst.secrets.encryption.salt=${FLOWCATALYST_SECRETS_SALT:flowcatalyst-default-salt}

# AWS providers (Secrets Manager / Parameter Store)
# Uses standard AWS SDK credential chain (env vars, instance profile, etc.)
flowcatalyst.secrets.aws.prefix=${FLOWCATALYST_SECRETS_AWS_PREFIX:}
flowcatalyst.secrets.aws.kms-key-id=${FLOWCATALYST_SECRETS_AWS_KMS_KEY:}

# GCP Secret Manager
flowcatalyst.secrets.gcp.enabled=${FLOWCATALYST_SECRETS_GCP_ENABLED:false}
flowcatalyst.secrets.gcp.project-id=${FLOWCATALYST_SECRETS_GCP_PROJECT:}

# HashiCorp Vault
# Configure via standard Quarkus Vault properties (quarkus.vault.*)
flowcatalyst.secrets.vault.prefix=${FLOWCATALYST_SECRETS_VAULT_PREFIX:flowcatalyst/}

# =============================================================================
# AWS SDK Configuration (for SQS and Secrets)
# =============================================================================

# Disable AWS devservices (use real or mocked AWS)
quarkus.secretsmanager.devservices.enabled=false
quarkus.ssm.devservices.enabled=false

# =============================================================================
# Vault Configuration (disabled by default)
# =============================================================================

# Disable Vault by default - enable explicitly when needed
quarkus.vault.devservices.enabled=false

# =============================================================================
# Dispatch Configuration (SQS Queue for dispatch jobs)
# =============================================================================

# SQS queue URL for dispatch job processing
flowcatalyst.dispatch.queue-url=${FLOWCATALYST_DISPATCH_QUEUE_URL:}

# Dispatch processing endpoint (internal endpoint that processes dispatch jobs)
flowcatalyst.dispatch.processing-endpoint=${FLOWCATALYST_DISPATCH_PROCESSING_ENDPOINT:http://localhost:8080/api/dispatch/process}

# Dev profile - use local ElasticMQ or mock SQS
%dev.flowcatalyst.dispatch.queue-url=http://localhost:9324/000000000000/dispatch-queue

# =============================================================================
# Platform Feature Flags
# =============================================================================

# Enable/disable messaging features (Event Types, Subscriptions, Dispatch Pools/Jobs)
# Set to false for businesses that don't need messaging capabilities
flowcatalyst.features.messaging-enabled=${FLOWCATALYST_FEATURES_MESSAGING_ENABLED:true}

# =============================================================================
# OpenAPI Configuration
# =============================================================================

# Generate OpenAPI schema file during build
quarkus.smallrye-openapi.store-schema-directory=openapi
quarkus.smallrye-openapi.info-title=FlowCatalyst Platform API
quarkus.smallrye-openapi.info-version=${quarkus.application.version:1.0.0}
quarkus.smallrye-openapi.info-description=FlowCatalyst Platform REST API

# =============================================================================
# Migration Configuration
# =============================================================================

# Enable MongoDB to PostgreSQL migration endpoint
# Only enable this temporarily during migration
flowcatalyst.migration.enabled=${FLOWCATALYST_MIGRATION_ENABLED:false}
%dev.flowcatalyst.migration.enabled=true