# =============================================================================
# FlowCatalyst Developer Build - Unified Configuration
# =============================================================================
# This configuration provides sensible defaults for local development.
# Override via environment variables or .env file.
# =============================================================================

# -----------------------------------------------------------------------------
# Application Info
# -----------------------------------------------------------------------------
quarkus.application.name=flowcatalyst-dev
quarkus.application.version=1.0.0-SNAPSHOT
quarkus.banner.enabled=true

# -----------------------------------------------------------------------------
# HTTP Server
# -----------------------------------------------------------------------------
quarkus.http.port=${HTTP_PORT:8080}
quarkus.http.host=0.0.0.0

# SPA Routing - serve index.html for all non-API routes
quarkus.http.enable-compression=true
quarkus.http.static-resources.index-page=index.html
quarkus.http.non-application-root-path=/q

# Proxy Configuration (for HTTPS behind load balancer)
quarkus.http.proxy.proxy-address-forwarding=true
quarkus.http.proxy.allow-x-forwarded=true
quarkus.http.proxy.enable-forwarded-host=true
quarkus.http.proxy.enable-forwarded-prefix=true

# -----------------------------------------------------------------------------
# MongoDB (Required)
# -----------------------------------------------------------------------------
quarkus.mongodb.connection-string=${MONGODB_URI:mongodb://localhost:27017/?replicaSet=rs0&directConnection=true}
quarkus.mongodb.database=${MONGODB_DATABASE:flowcatalyst}

# -----------------------------------------------------------------------------
# Bean Configuration
# -----------------------------------------------------------------------------
quarkus.arc.remove-unused-beans=false
smallrye.config.mapping.validate-unknown=false

# -----------------------------------------------------------------------------
# Default PostgreSQL DataSource (required for JDBI repositories)
# -----------------------------------------------------------------------------
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=${POSTGRES_URL:jdbc:postgresql://localhost:5432/flowcatalyst}
quarkus.datasource.username=${POSTGRES_USER:flowcatalyst}
quarkus.datasource.password=${POSTGRES_PASSWORD:flowcatalyst}
quarkus.datasource.jdbc.max-size=20
quarkus.datasource.devservices.enabled=false

# -----------------------------------------------------------------------------
# Message Router - Embedded Queue (SQLite)
# -----------------------------------------------------------------------------
message-router.enabled=true
message-router.queue-type=EMBEDDED
message-router.sync-interval=5m
message-router.max-pools=2000
message-router.pool-warning-threshold=1000

# Embedded Queue Configuration
message-router.embedded.visibility-timeout-seconds=30
message-router.embedded.receive-timeout-ms=1000

# Dispatch Queue (using embedded, SQS not needed - placeholder for config validation)
# Jobs are picked up by PendingJobPoller from MongoDB when SQS is unavailable
flowcatalyst.dispatch.queue-url=embedded://dispatch-queue

# HTTP Mediator Configuration
mediator.http.version=HTTP_1_1

# REST Client Configuration (internal - same process)
quarkus.rest-client.message-router-config.url=http://localhost:${HTTP_PORT:8080}/api/config
quarkus.rest-client.message-router-config.scope=jakarta.inject.Singleton
quarkus.rest-client.message-router-config.connect-timeout=3000
quarkus.rest-client.message-router-config.read-timeout=5000

# Embedded Queue DataSource (SQLite - shared with dispatch scheduler)
quarkus.datasource.embedded-queue.db-kind=sqlite
quarkus.datasource.embedded-queue.jdbc.url=jdbc:sqlite:${QUEUE_DB_PATH:./data/flowcatalyst-queue.db}
quarkus.datasource.embedded-queue.jdbc.max-size=16
quarkus.datasource.embedded-queue.devservices.enabled=false

# -----------------------------------------------------------------------------
# Dispatch Scheduler
# -----------------------------------------------------------------------------
dispatch-scheduler.enabled=true
dispatch-scheduler.queue-type=EMBEDDED
dispatch-scheduler.embedded-db-path=${QUEUE_DB_PATH:./data/flowcatalyst-queue.db}
dispatch-scheduler.poll-interval=5s
dispatch-scheduler.batch-size=20
dispatch-scheduler.max-concurrent-groups=10
dispatch-scheduler.processing-endpoint=http://localhost:${HTTP_PORT:8080}/api/dispatch/process
dispatch-scheduler.stale-queued-threshold-minutes=15
dispatch-scheduler.stale-queued-poll-interval=60s

# -----------------------------------------------------------------------------
# Stream Processor
# -----------------------------------------------------------------------------
stream-processor.enabled=true
stream-processor.database=flowcatalyst

# Events stream - projects events to events_read
stream-processor.streams.events.enabled=true
stream-processor.streams.events.source-collection=events
stream-processor.streams.events.projection-collection=events_read
stream-processor.streams.events.mapper=events
stream-processor.streams.events.checkpoint-key=events-stream-checkpoint
stream-processor.streams.events.watch-operations=insert
stream-processor.streams.events.concurrency=10
stream-processor.streams.events.batch-max-size=100
stream-processor.streams.events.batch-max-wait-ms=100

# Dispatch Jobs stream - projects dispatch_jobs to dispatch_jobs_read
stream-processor.streams.dispatch-jobs.enabled=true
stream-processor.streams.dispatch-jobs.source-collection=dispatch_jobs
stream-processor.streams.dispatch-jobs.projection-collection=dispatch_jobs_read
stream-processor.streams.dispatch-jobs.mapper=dispatch-jobs
stream-processor.streams.dispatch-jobs.checkpoint-key=dispatch-jobs-stream-checkpoint
stream-processor.streams.dispatch-jobs.watch-operations=insert,update
stream-processor.streams.dispatch-jobs.concurrency=5
stream-processor.streams.dispatch-jobs.batch-max-size=50
stream-processor.streams.dispatch-jobs.batch-max-wait-ms=100

# -----------------------------------------------------------------------------
# Outbox Processor (Optional - enable for integration testing)
# -----------------------------------------------------------------------------
outbox-processor.enabled=${OUTBOX_ENABLED:false}
outbox-processor.database-type=${OUTBOX_DB_TYPE:POSTGRESQL}
outbox-processor.poll-interval=1s
outbox-processor.poll-batch-size=500
outbox-processor.api-batch-size=100
outbox-processor.max-concurrent-groups=10
outbox-processor.api-base-url=http://localhost:${HTTP_PORT:8080}
outbox-processor.events-table=outbox_events
outbox-processor.dispatch-jobs-table=outbox_dispatch_jobs
outbox-processor.max-retries=3
outbox-processor.retry-delay-seconds=60
outbox-processor.processing-timeout-seconds=300

# Outbox Database (PostgreSQL by default)
quarkus.datasource.outbox.db-kind=${OUTBOX_DB_KIND:postgresql}
quarkus.datasource.outbox.jdbc.url=${OUTBOX_DB_URL:jdbc:postgresql://localhost:5432/outbox}
quarkus.datasource.outbox.username=${OUTBOX_DB_USER:postgres}
quarkus.datasource.outbox.password=${OUTBOX_DB_PASS:postgres}
quarkus.datasource.outbox.jdbc.max-size=10
quarkus.datasource.outbox.devservices.enabled=false

# -----------------------------------------------------------------------------
# Standby Service (Single instance - always primary)
# -----------------------------------------------------------------------------
standby.enabled=false
standby.instance-id=dev-build-1

# Quarkus Redis config (not used when standby.enabled=false)
quarkus.redis.hosts=redis://localhost:6379

# -----------------------------------------------------------------------------
# Dev Data Seeding
# -----------------------------------------------------------------------------
# Force seed dev data (admin user, sample clients, event types) on startup
# This runs even in NORMAL launch mode (native executable)
flowcatalyst.dev.force-seed=true

# -----------------------------------------------------------------------------
# Platform Auth (Development defaults)
# -----------------------------------------------------------------------------
flowcatalyst.auth.mode=embedded
flowcatalyst.auth.external-base-url=http://localhost:${HTTP_PORT:8080}

# Development app key for encryption
flowcatalyst.app-key=K7gNU3sdo+OL0wNhqoVWhr3g6s1xYv72ol/pe/Unols=

# JWT Configuration
flowcatalyst.auth.jwt.issuer=flowcatalyst-dev
flowcatalyst.auth.jwt.access-token-expiry=PT1H
flowcatalyst.auth.jwt.session-token-expiry=PT8H
flowcatalyst.auth.jwt.refresh-token-expiry=P30D
flowcatalyst.auth.jwt.authorization-code-expiry=PT10M

# Session cookies (less secure for localhost)
flowcatalyst.auth.session.secure=false
flowcatalyst.auth.session.same-site=Lax
flowcatalyst.auth.session.cookie-name=FLOWCATALYST_SESSION

# SmallRye JWT Configuration
mp.jwt.verify.issuer=flowcatalyst-dev
mp.jwt.verify.publickey.location=http://localhost:${HTTP_PORT:8080}/.well-known/jwks.json
mp.jwt.token.cookie=FLOWCATALYST_SESSION
mp.jwt.token.header=Authorization

# -----------------------------------------------------------------------------
# HTTP Auth Permissions
# -----------------------------------------------------------------------------
# Auth endpoints must be public
quarkus.http.auth.permission.auth-public.paths=/auth/login,/auth/check-domain,/auth/oidc/*,/oauth/token,/.well-known/*
quarkus.http.auth.permission.auth-public.policy=permit

# Platform config endpoint public (needed before auth for UI initialization)
quarkus.http.auth.permission.config-public.paths=/api/config/platform
quarkus.http.auth.permission.config-public.policy=permit

# Health endpoints public
quarkus.http.auth.permission.health-public.paths=/q/health/*,/health/*
quarkus.http.auth.permission.health-public.policy=permit

# Message router public paths
quarkus.http.auth.permission.router-public.paths=/monitoring/health,/monitoring/dashboard,/monitoring/standby-status,/monitoring/queue-stats
quarkus.http.auth.permission.router-public.policy=permit

# -----------------------------------------------------------------------------
# Secret Management (encrypted provider for dev)
# -----------------------------------------------------------------------------
flowcatalyst.secrets.default-provider=encrypted
flowcatalyst.secrets.encryption.salt=flowcatalyst-default-salt

# Disable AWS/GCP/Vault dev services
quarkus.secretsmanager.devservices.enabled=false
quarkus.ssm.devservices.enabled=false
quarkus.vault.devservices.enabled=false

# -----------------------------------------------------------------------------
# IDP Configuration (disabled for dev)
# -----------------------------------------------------------------------------
flowcatalyst.idp.anchor.enabled=false
flowcatalyst.idp.platform.enabled=false

# -----------------------------------------------------------------------------
# Queue Health & Notifications (disabled for dev)
# -----------------------------------------------------------------------------
queue.health.monitor.enabled=false
notification.enabled=false
notification.email.enabled=false
notification.teams.enabled=false
quarkus.mailer.mock=true

# Message router auth (disabled for dev)
authentication.enabled=false
authentication.mode=NONE
quarkus.oidc.enabled=false

# -----------------------------------------------------------------------------
# SQS (disabled - using embedded)
# -----------------------------------------------------------------------------
quarkus.sqs.devservices.enabled=false

# Use URL connection client for all AWS services (native-image compatible, no CRT)
quarkus.sqs.sync-client.type=url
quarkus.secretsmanager.sync-client.type=url
quarkus.ssm.sync-client.type=url

# -----------------------------------------------------------------------------
# Logging (text format for dev build, override prod JSON)
# -----------------------------------------------------------------------------
quarkus.log.level=INFO
quarkus.log.category."tech.flowcatalyst".level=DEBUG
quarkus.log.console.json.enabled=false
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
%prod.quarkus.log.console.json.enabled=false

# Reduce noise from libraries
quarkus.log.category."io.quarkus".level=INFO
quarkus.log.category."org.mongodb".level=WARN
quarkus.log.category."io.smallrye".level=INFO

# -----------------------------------------------------------------------------
# Quarkus Dev Services (disabled - use docker compose)
# -----------------------------------------------------------------------------
quarkus.devservices.enabled=false

# -----------------------------------------------------------------------------
# Native Build Configuration
# -----------------------------------------------------------------------------
quarkus.native.additional-build-args=\
  --report-unsupported-elements-at-runtime,\
  --initialize-at-run-time=org.sqlite.core.NativeDB,\
  --initialize-at-run-time=com.github.f4b6a3.tsid.TsidCreator,\
  --initialize-at-run-time=com.github.f4b6a3.tsid.TsidCreator$FactoryHolder,\
  --initialize-at-run-time=com.github.f4b6a3.tsid.TsidFactory,\
  --initialize-at-run-time=jnr.unixsocket.UnixSocket,\
  --initialize-at-run-time=jnr.enxio.channels.NativeSelectorProvider,\
  --initialize-at-run-time=tech.flowcatalyst.platform.authentication.oidc.OidcLoginResource,\
  --initialize-at-run-time=tech.flowcatalyst.platform.authentication.oauth.AuthorizationResource,\
  --initialize-at-run-time=tech.flowcatalyst.platform.authentication.oauth.PkceService,\
  --initialize-at-run-time=tech.flowcatalyst.platform.security.secrets.providers.EncryptedSecretProvider,\
  --initialize-at-run-time=tech.flowcatalyst.platform.admin.OAuthClientAdminResource,\
  --initialize-at-run-time=tech.flowcatalyst.platform.application.operations.provisionserviceaccount.ProvisionServiceAccountUseCase

# -----------------------------------------------------------------------------
# Platform Feature Flags
# -----------------------------------------------------------------------------
# Enable/disable messaging features (Event Types, Subscriptions, Dispatch Pools/Jobs)
flowcatalyst.features.messaging-enabled=${FLOWCATALYST_FEATURES_MESSAGING_ENABLED:true}
