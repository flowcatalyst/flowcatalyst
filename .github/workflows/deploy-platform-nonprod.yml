name: Deploy Platform (nonprod)

on:
  push:
    branches: [main]
    paths:
      - 'flowcatalyst-typescript/apps/flowcatalyst/**'
      - 'flowcatalyst-typescript/apps/platform-frontend/**'
      - 'flowcatalyst-typescript/pnpm-lock.yaml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  packages: write

env:
  AWS_REGION: af-south-1
  IMAGE: ghcr.io/flowcatalyst/flowcatalyst
  ECS_CLUSTER: inhance-np-cluster
  ECS_SERVICE: inhance-fc-np-svc
  TASK_FAMILY: inhance-fc-np-platform

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Build & Push to GHCR ────────────────────────────────────
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        working-directory: flowcatalyst-typescript
        run: |
          docker build \
            --platform linux/amd64 \
            -f apps/flowcatalyst/Dockerfile \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:latest \
            .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest

      # ── AWS Steps ───────────────────────────────────────────────
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ── Register New Task Definition ────────────────────────────
      - name: Register new task definition
        id: taskdef
        run: |
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY \
            --query 'taskDefinition' --output json)

          NEW_TASK_DEF=$(echo "$TASK_DEF" | jq \
            --arg IMAGE "$IMAGE:${{ github.sha }}" \
            '.containerDefinitions[0].image = $IMAGE |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          NEW_REVISION=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' --output text)

          echo "revision=$NEW_REVISION" >> "$GITHUB_OUTPUT"
          echo "New task definition: $NEW_REVISION"

      # ── Run Migrations ──────────────────────────────────────────
      - name: Run database migrations
        env:
          TASK_DEF_ARN: ${{ steps.taskdef.outputs.revision }}
        run: |
          SUBNETS=$(aws ecs describe-services --cluster $ECS_CLUSTER --services $ECS_SERVICE \
            --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' --output json)
          SECURITY_GROUPS=$(aws ecs describe-services --cluster $ECS_CLUSTER --services $ECS_SERVICE \
            --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups' --output json)

          TASK_ARN=$(aws ecs run-task \
            --cluster $ECS_CLUSTER \
            --task-definition "$TASK_DEF_ARN" \
            --launch-type FARGATE \
            --network-configuration "{
              \"awsvpcConfiguration\": {
                \"subnets\": $SUBNETS,
                \"securityGroups\": $SECURITY_GROUPS,
                \"assignPublicIp\": \"ENABLED\"
              }
            }" \
            --overrides "{
              \"containerOverrides\": [{
                \"name\": \"flowcatalyst\",
                \"command\": [\"migrate\"]
              }]
            }" \
            --query 'tasks[0].taskArn' --output text)

          echo "Migration task: $TASK_ARN"
          aws ecs wait tasks-stopped --cluster $ECS_CLUSTER --tasks $TASK_ARN

          EXIT_CODE=$(aws ecs describe-tasks --cluster $ECS_CLUSTER --tasks $TASK_ARN \
            --query 'tasks[0].containers[0].exitCode' --output text)
          if [ "$EXIT_CODE" != "0" ]; then
            echo "::error::Migration failed with exit code $EXIT_CODE"
            aws ecs describe-tasks --cluster $ECS_CLUSTER --tasks $TASK_ARN \
              --query 'tasks[0].stoppedReason' --output text
            exit 1
          fi
          echo "Migrations complete"

      # ── Deploy ──────────────────────────────────────────────────
      - name: Update ECS service
        env:
          TASK_DEF_ARN: ${{ steps.taskdef.outputs.revision }}
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition "$TASK_DEF_ARN" \
            --query 'service.taskDefinition' --output text

          echo "Deployment triggered"
