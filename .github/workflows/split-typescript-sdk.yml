name: Split TypeScript SDK

on:
  push:
    tags:
      - 'typescript-sdk/v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create on target repo (e.g., v1.0.0). Leave empty to just sync main.'
        required: false

jobs:
  split:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install splitsh-lite
        run: |
          curl -L https://github.com/splitsh/lite/releases/download/v1.0.1/lite_linux_amd64.tar.gz | tar xz
          chmod +x splitsh-lite
          sudo mv splitsh-lite /usr/local/bin/

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Split and Push
        env:
          TARGET_REPO: https://x-access-token:${{ secrets.TYPESCRIPT_SDK_TOKEN }}@github.com/flowcatalyst/typescript-sdk.git
        run: |
          # Extract version from tag (typescript-sdk/v1.0.0 -> v1.0.0)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#typescript-sdk/}"
          elif [[ -n "${{ github.event.inputs.tag }}" ]]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=""
          fi

          # Split the subtree
          SHA=$(splitsh-lite --prefix=clients/typescript/flowcatalyst-sdk)
          echo "Split SHA: $SHA"

          # Add remote
          git remote add sdk "$TARGET_REPO" || git remote set-url sdk "$TARGET_REPO"

          # Push the split branch to main
          git push sdk "$SHA:refs/heads/main" --force

          # Push tag if we have a version
          if [[ -n "$VERSION" ]]; then
            git tag -f "$VERSION" "$SHA"
            git push sdk "$VERSION" --force
            echo "Tagged and pushed: $VERSION"
          fi

          echo "Successfully pushed to flowcatalyst/typescript-sdk"
