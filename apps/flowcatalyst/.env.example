# FlowCatalyst Configuration
# Copy this to .env and modify as needed.

# =============================================================================
# Service Toggles
# =============================================================================
# Enable/disable individual services in this process.
PLATFORM_ENABLED=true
MESSAGE_ROUTER_ENABLED=false
STREAM_PROCESSOR_ENABLED=true

# Run database migrations on startup (default: true in development, false in production)
AUTO_MIGRATE=true

# =============================================================================
# Frontend
# =============================================================================
# Optional: path to built frontend assets (auto-detected if omitted)
# FRONTEND_DIR=./dist/frontend

# =============================================================================
# Server
# =============================================================================
PLATFORM_PORT=3000
ROUTER_PORT=8080
HOST=0.0.0.0
NODE_ENV=development
LOG_LEVEL=debug

# =============================================================================
# Database
# =============================================================================
DATABASE_URL=postgres://postgres:postgres@localhost:5432/flowcatalyst

# =============================================================================
# OIDC / Auth (Platform)
# =============================================================================
# JWT_SECRET=                          # Symmetric secret (dev only, prefer RS256 keys)
# JWT_ISSUER=flowcatalyst
# JWT_AUDIENCE=flowcatalyst
# EXTERNAL_BASE_URL=https://your-domain.com
# OIDC_ISSUER=https://your-domain.com
# OIDC_COOKIES_KEYS=secret-key-1,secret-key-2

# RS256 JWT keys (checked in priority order)
# Option 1: Base64-encoded PEM content (containers/cloud — same env vars as Java platform)
# Generate with: base64 -w0 private.pem / base64 -w0 public.pem
# FLOWCATALYST_JWT_PRIVATE_KEY=         # base64(private.pem)
# FLOWCATALYST_JWT_PUBLIC_KEY=          # base64(public.pem)
# FLOWCATALYST_JWT_PREVIOUS_PUBLIC_KEY= # base64(old-public.pem) for zero-downtime key rotation
# Option 2: Key directory (rotation-capable, use with `flowcatalyst rotate-keys`)
# JWT_KEY_DIR=.jwt-keys
# Option 3: Single key file paths (legacy production)
# JWT_PRIVATE_KEY_PATH=/path/to/private.pem
# JWT_PUBLIC_KEY_PATH=/path/to/public.pem
# Option 4 (default): Auto-generated dev keys
# JWT_DEV_KEY_DIR=.jwt-keys

# OIDC token expiry (seconds)
# OIDC_ACCESS_TOKEN_TTL=3600          # 1 hour
# OIDC_ID_TOKEN_TTL=3600              # 1 hour
# OIDC_REFRESH_TOKEN_TTL=2592000      # 30 days
# OIDC_SESSION_TTL=86400              # 24 hours
# OIDC_AUTH_CODE_TTL=600              # 10 minutes

# =============================================================================
# Encryption Key (Platform)
# =============================================================================
# 32-byte hex key for AES-256-GCM encryption of secrets
# Generate with: openssl rand -hex 32
FLOWCATALYST_APP_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

# =============================================================================
# Bootstrap Admin (first-run setup)
# =============================================================================
# Set these to create an initial admin user on first startup.
# Only runs if no ANCHOR-scoped users exist in the database.
FLOWCATALYST_BOOTSTRAP_ADMIN_EMAIL=admin@example.com
FLOWCATALYST_BOOTSTRAP_ADMIN_PASSWORD=ChangeMe123!
# FLOWCATALYST_BOOTSTRAP_ADMIN_NAME=Bootstrap Admin

# =============================================================================
# Dispatch Queue (Platform → Message Router)
# =============================================================================
# After a use-case commits, MessagePointers are pushed onto a queue so the
# message router immediately picks up new dispatch jobs.
# NONE = no post-commit queue push (jobs stay in DB until polled)
# EMBEDDED = push to in-process embedded queue (requires MESSAGE_ROUTER_ENABLED=true)
# SQS = push to AWS SQS FIFO queue
DISPATCH_QUEUE_TYPE=NONE
# DISPATCH_QUEUE_URL=https://sqs.eu-west-1.amazonaws.com/123456789/dispatch.fifo
# DISPATCH_QUEUE_REGION=eu-west-1
# SQS_ENDPOINT=http://localhost:4566  # LocalStack

# =============================================================================
# Dispatch Scheduler (Platform)
# =============================================================================
# Polls PENDING dispatch jobs and publishes them to the message queue.
# Used for manually re-queued jobs (e.g. via frontend retry button).
# Auto-enabled when messaging is enabled (platform config: messagingEnabled)
# and a dispatch queue is configured (DISPATCH_QUEUE_TYPE != NONE).
# DISPATCH_SCHEDULER_POLL_INTERVAL_MS=5000
# DISPATCH_SCHEDULER_BATCH_SIZE=20
# DISPATCH_SCHEDULER_MAX_CONCURRENT_GROUPS=10
# DISPATCH_SCHEDULER_PROCESSING_ENDPOINT=http://localhost:8080/api/dispatch/process
# DISPATCH_SCHEDULER_DEFAULT_POOL_CODE=DISPATCH-POOL
# DISPATCH_SCHEDULER_STALE_THRESHOLD_MINUTES=15
# DISPATCH_SCHEDULER_STALE_POLL_INTERVAL_MS=60000

# =============================================================================
# Stream Processor
# =============================================================================
# STREAM_PROCESSOR_EVENTS_ENABLED=true
# STREAM_PROCESSOR_EVENTS_BATCH_SIZE=100
# STREAM_PROCESSOR_DISPATCH_JOBS_ENABLED=true
# STREAM_PROCESSOR_DISPATCH_JOBS_BATCH_SIZE=100

# =============================================================================
# Message Router
# =============================================================================
# Queue type: EMBEDDED uses in-memory SQLite (no external dependencies)
QUEUE_TYPE=EMBEDDED
# EMBEDDED_DB_PATH=:memory:

# =============================================================================
# Hot Standby (Redis-based leader election)
# =============================================================================
# Enable hot standby mode for automatic failover between instances.
# Requires Redis. When disabled (default), runs as single instance.
STANDBY_ENABLED=false
# STANDBY_INSTANCE_ID=                  # Unique instance ID (default: HOSTNAME or auto-generated)
# STANDBY_LOCK_KEY=message-router-primary-lock
# STANDBY_LOCK_TTL_SECONDS=30           # Lock TTL (standby takes over after expiry)
# REDIS_URL=redis://localhost:6379

# =============================================================================
# Message Router Authentication
# =============================================================================
# Disabled by default for local development
AUTHENTICATION_ENABLED=false
AUTHENTICATION_MODE=NONE

# =============================================================================
# Outbox Processor
# =============================================================================
# Polls a customer's outbox_messages table and POSTs batches to the platform.
# Requires a separate database connection to the customer DB.
OUTBOX_PROCESSOR_ENABLED=false
# OUTBOX_PROCESSOR_DATABASE_URL=postgres://postgres:postgres@localhost:5432/customer_db
# OUTBOX_PROCESSOR_API_BASE_URL=http://localhost:3000
# OUTBOX_PROCESSOR_API_TOKEN=                    # Optional bearer token
# OUTBOX_PROCESSOR_POLL_INTERVAL_MS=1000
# OUTBOX_PROCESSOR_POLL_BATCH_SIZE=500
# OUTBOX_PROCESSOR_API_BATCH_SIZE=100
# OUTBOX_PROCESSOR_MAX_CONCURRENT_GROUPS=10
# OUTBOX_PROCESSOR_GLOBAL_BUFFER_SIZE=1000
# OUTBOX_PROCESSOR_MAX_IN_FLIGHT=5000
# OUTBOX_PROCESSOR_MAX_RETRIES=3
# OUTBOX_PROCESSOR_PROCESSING_TIMEOUT_SECONDS=300
# OUTBOX_PROCESSOR_RECOVERY_INTERVAL_MS=60000
# OUTBOX_PROCESSOR_EVENTS_TABLE=outbox_messages
# OUTBOX_PROCESSOR_DISPATCH_JOBS_TABLE=outbox_messages
# OUTBOX_PROCESSOR_AUDIT_LOGS_TABLE=outbox_messages
